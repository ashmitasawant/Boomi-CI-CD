name: Deployment Pipeline

on:
  push:
    paths:
     - 'DeploymentConfiguration/*'
  workflow_dispatch:

jobs:
  getEnvironmentInfo:
   runs-on: ubuntu-latest
   outputs:
     devEnvironmentId: ${{steps.setEnvironmentLevelInfo.outputs.devEnvironmentId}}
     devAtomId: ${{steps.setEnvironmentLevelInfo.outputs.devAtomId}}
     testEnvironmentId: ${{steps.setEnvironmentLevelInfo.outputs.testEnvironmentId}}
     testAtomId: ${{steps.setEnvironmentLevelInfo.outputs.testAtomId}}
   steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Get Process Info
        uses: actions/checkout@v2
      - id: setEnvironmentLevelInfo
        run: |
            DevEnvironmentDetails=$(cat ./EnvironmentConfiguration/Dev.Env.Config.json)
            devEnvironmentID=$(echo  ${DevEnvironmentDetails} | jq '.[] | .environmentId')
            echo $devEnvironmentID
            echo "::set-output name=devEnvironmentId::$devEnvironmentID"
            
            devAtomID=$(echo ${DevEnvironmentDetails} | jq '.[] | .atomId')
            echo $devAtomID
            echo "::set-output name=devAtomId::$devAtomID"
            
            TestEnvironmentDetails=$(cat ./EnvironmentConfiguration/Test.Env.Config.json)
            testEnvironmentID=$(echo  ${TestEnvironmentDetails} | jq '.[] | .environmentId')
            echo $testEnvironmentID
            echo "::set-output name=testEnvironmentId::$testEnvironmentID"
            
            testAtomID=$(echo ${TestEnvironmentDetails} | jq '.[] | .atomId')
            echo $testAtomID
            echo "::set-output name=testAtomId::$testAtomID"
  
  deployments:
    outputs:
      componentIds: ${{ steps.setProcessLevelInfo.outputs.componentIds }}
      packageVersions: ${{ steps.setProcessLevelInfo.outputs.packageVersions }}
      processNames: ${{steps.setProcessLevelInfo.outputs.processNames}}
      environmentName: ${{steps.setProcessLevelInfo.outputs.environmentName}}
      modes: ${{steps.setProcessLevelInfo.outputs.modes}}
      deploymentIds: ${{steps.setProcessLevelInfo.outputs.deploymentIds}}
    environment: Dev
    env: 
      BOOMI_AUTHORIZATION: ${{ secrets.BOOMI_AUTHORIZATION }}
    runs-on: ubuntu-latest
    steps:
      - name: Package Creation and Deployment 
        uses: actions/checkout@v2
      - id: setProcessLevelInfo
        run: |
             lastCommitTimestampForHxFiles=$(git log -1 --date=format:"%Y/%m/%d %T" --format="%ad" ./DeploymentConfiguration/ProcessDetails.HX_Demo.dev.json)
             lastCommitTimestampForCrowFiles=$(git log -1 --date=format:"%Y/%m/%d %T" --format="%ad" ./DeploymentConfiguration/ProcessDetails.Crow_Demo.dev.json)
             lastCommitTimestampForEventsFiles=$(git log -1 --date=format:"%Y/%m/%d %T" --format="%ad" ./DeploymentConfiguration/ProcessDetails.Events_Demo.dev.json)

              if [[ $(date -d "$lastCommitTimestampForHxFiles") > $(date -d "$lastCommitTimestampForCrowFiles") ]]
              then 
                 fileToBeRead="ProcessDetails.HX_Demo.dev.json"
                 fileRead=$(cat ./DeploymentConfiguration/ProcessDetails.HX_Demo.dev.json)
              else 
                 fileToBeRead="ProcessDetails.Crow_Demo.dev.json"
                 fileRead=$(cat ./DeploymentConfiguration/ProcessDetails.Crow_Demo.dev.json)
              fi
              
              if [[ $(date -d "$lastCommitTimestampForHxFiles") > $(date -d "$lastCommitTimestampForEventsFiles") ]] 
              then
                 fileToBeRead="ProcessDetails.HX_Demo.dev.json"
                 fileRead=$(cat ./DeploymentConfiguration/ProcessDetails.HX_Demo.dev.json)
              else 
                 fileToBeRead="ProcessDetails.Events_Demo.dev.json"
                 fileRead=$(cat ./DeploymentConfiguration/ProcessDetails.Events_Demo.dev.json)
              fi
              
              if [[ $(date -d "$lastCommitTimestampForCrowFiles") > $(date -d "$lastCommitTimestampForEventsFiles") ]] 
              then
                 fileToBeRead="ProcessDetails.Crow_Demo.dev.json"
                 fileRead=$(cat ./DeploymentConfiguration/ProcessDetails.Crow_Demo.dev.json)
              else 
                 fileToBeRead="ProcessDetails.Events_Demo.dev.json"
                 fileRead=$(cat ./DeploymentConfiguration/ProcessDetails.Events_Demo.dev.json)
              fi
              echo $fileToBeRead
              echo $fileRead
              
              environmentName=$(echo ${fileRead} | jq '.[] | .environmentName')
              echo $environmentName
              echo "::set-output name=environmentName::$environmentName"
              processName=$(echo ${fileRead} | jq '.[] | .processDetails[].processName')
              componentID=$(echo  ${fileRead} | jq '.[] | .processDetails[].componentID')
              packageVersion=$(echo  ${fileRead} | jq '.[] | .processDetails[].packageVersion')
              mode=$(echo  ${fileRead} | jq '.[] | .processDetails[].mode')
              deploymentID=$(echo  ${fileRead} | jq '.[] | .processDetails[].deploymentID')

              ComponentsArray=$(echo $componentID)
              echo $ComponentsArray
              echo "::set-output name=componentIds::($ComponentsArray)"

              ProcessNamesArray=$(echo $processName)
              echo $ProcessNamesArray
              echo "::set-output name=processNames::($ProcessNamesArray)"

              PackageVersionArray=$(echo $packageVersion)
              echo $PackageVersionArray
              echo "::set-output name=packageVersions::($PackageVersionArray)"

              ModeArray=$(echo $mode)
              echo $ModeArray
              echo "::set-output name=modes::($ModeArray)"

              DeploymentsArray=$(echo $deploymentID)
              echo $DeploymentsArray
              echo "::set-output name=deploymentIds::($DeploymentsArray)"
            
